@using SIGESDOC.Web.Seguridad

@model SIGESDOC.Web.Models.ConsultarDniViewModel

@{
    ViewBag.Title = "Nueva Persona";
}

<div class="bottom hidden"></div>
<div id="mensajes"></div>

<ol class="breadcrumb" style="margin-bottom: 5px;">
    <li><a href="#">DNI / CE</a></li>
    <li class="active">Nuevo</li>
</ol>

<div class="bs-callout bs-callout-info">
    <h4>Registrar Nuevo DNI/CE</h4>
    <p>Use el siguiente formulario para registrar una nueva persona</p>
</div>

@using (Html.BeginForm("Nueva_Natural", "HojaTramite", FormMethod.Post, new { @id = "nuevoForm", @enctype = "multipart/form-data" }))
{

    @Html.AntiForgeryToken()
    <div class="form-horizontal">
        <ol class="breadcrumb">
            <li class="active">Información de la Persona</li>
        </ol>

        <div class="row hidden">
            @Html.TextBox("var_guardar", (string)ViewBag.cond_grabar)
            @Html.TextBoxFor(m => m.tipo_doc_iden, new { @class = "form-control input-sm" })
            @Html.TextBoxFor(m => m.ubigeo, new { @class = "form-control input-sm" })
            @Html.TextBoxFor(m => m.sexo, new { @class = "form-control input-sm" })
            @Html.TextBoxFor(m => m.fecha_nacimiento, new { @class = "form-control input-sm" })
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="cmbtipo_doc_iden">Tipo de Documento</label>
            <div class="col-md-3">
                @Html.DropDownList("cmbtipo_doc_iden", (IEnumerable<SelectListItem>)ViewBag.lst_tipo_doc_iden, new { @class = "form-control input-sm" })
            </div>
            <div class="col-md-2">
                @Html.TextBoxFor(m => m.persona_num_documento, new { @class = "form-control input-sm", @maxlength = "20" })
            </div>
            <div class="col-md-3">
                <label id="lbl_valida_persona_num_documento" style="color: #B44D4D">  </label>
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.paterno, new { @class = "col-md-2 control-label" })
            <div class="col-md-5">
                @Html.TextBoxFor(m => m.paterno, new { @class = "form-control input-sm", @maxlength = "50" })
            </div>
            <div class="col-md-3">
                <label id="lbl_valida_paterno" style="color: #B44D4D">  </label>
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.materno, new { @class = "col-md-2 control-label" })
            <div class="col-md-5">
                @Html.TextBoxFor(m => m.materno, new { @class = "form-control input-sm", @maxlength = "50" })
            </div>
            <div class="col-md-3">
                <label id="lbl_valida_materno" style="color: #B44D4D">  </label>
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.nombres, new { @class = "col-md-2 control-label" })
            <div class="col-md-5">
                @Html.TextBoxFor(m => m.nombres, new { @class = "form-control input-sm", @maxlength = "50" })
            </div>
            <div class="col-md-3">
                <label id="lbl_valida_nombres" style="color: #B44D4D">  </label>
            </div>
        </div>

        <div class="form-group" hidden="hidden">
            <label class="col-md-2 control-label" for="dtpFechaNacimiento">Fecha Nacimiento</label>
            <div class="col-md-2">
                <div class="input-group date input-group-sm" id="dtpFechaNacimiento">
                    <input class="form-control input-sm" id="txtFechaNacimiento" type="text" value="">
                    <span class="input-group-addon input-sm add-on">
                        <a href="#">
                            <i class="glyphicon glyphicon-calendar" data-date-icon="glyphicon glyphicon-calendar"></i>
                        </a>
                    </span>
                </div>
            </div>

            <div class="col-md-3">
                <label id="lbl_valida_fecha_nacimiento" style="color: #B44D4D">  </label>
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="cmblista_sexo">Sexo</label>
            <div class="col-md-4">
                @Html.DropDownList("cmblista_sexo", (IEnumerable<SelectListItem>)ViewBag.lstsexo, new { @class = "form-control input-sm" })
            </div>

            <div class="col-md-3">
                <label id="lbl_valida_sexo" style="color: #B44D4D">  </label>
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="cmblista_departamento">Departamento</label>
            <div class="col-md-5">
                @Html.DropDownList("cmblista_departamento", (IEnumerable<SelectListItem>)ViewBag.lst_departamento, new { @class = "form-control input-sm" })
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="cmblista_provincia">Provincia</label>
            <div class="col-md-5">
                @Html.DropDownList("cmblista_provincia", (IEnumerable<SelectListItem>)ViewBag.lst_provincia, new { @class = "form-control input-sm" })
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2" for="cmblista_distrito">Distrito</label>
            <div class="col-md-5">
                @Html.DropDownList("cmblista_distrito", (IEnumerable<SelectListItem>)ViewBag.lst_distrito, new { @class = "form-control input-sm" })
            </div>

            <div class="col-md-3">
                <label id="lbl_valida_distrito" style="color: #B44D4D">  </label>
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.direccion, new { @class = "col-md-2 control-label" })
            <div class="col-md-4">
                @Html.TextBoxFor(m => m.direccion, new { @class = "form-control input-sm", @maxlength = "200" })
            </div>

            <div class="col-md-3">
                <label id="lbl_valida_direccion" style="color: #B44D4D">  </label>
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.ruc, new { @class = "col-md-2 control-label" })
            <div class="col-md-4">
                @Html.TextBoxFor(m => m.ruc, new { @class = "form-control input-sm", @maxlength = "11", @onkeypress = "return IsNumeric(this.value);" })
            </div>

            <div class="col-md-3">
                <label id="lbl_valida_ruc" style="color: #B44D4D">  </label>
            </div>
        </div>


        <hr>
        <div class="form-group">
            <div class="col-md-8">
                <button id="btnGrabar" type="button" class="btn btn-primary btn-sm">Grabar</button>
                <button type="button" class="btn btn-default btn-sm regresar">Cancelar</button>
                <button id="btnLimpiar" type="button" class="btn btn-default btn-sm">Limpiar</button>

            </div>
        </div>
    </div>
}

<!-- Modal -->
<div class="modal fade" id="loadMe" tabindex="-1" role="dialog" aria-labelledby="loadMeLabel">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="loader"></div>
                <div clas="loader-txt">
                    <p>Consultando información, por favor espere...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /** SPINNER CREATION **/
    .loader {
        position: relative;
        text-align: center;
        margin: 15px auto 35px auto;
        z-index: 9999;
        display: block;
        width: 80px;
        height: 80px;
        border: 10px solid rgba(0, 0, 0, .3);
        border-radius: 50%;
        border-top-color: #000;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
    }

    @@keyframes spin {
        to {
            -webkit-transform: rotate(360deg);
        }
    }

    @@-webkit-keyframes spin {
        to {
            -webkit-transform: rotate(360deg);
        }
    }

    /** MODAL STYLING **/
    .modal-content {
        border-radius: 0px;
        box-shadow: 0 0 20px 8px rgba(0, 0, 0, 0.7);
    }

    .modal-backdrop.show {
        opacity: 0.75;
    }
</style>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}

<script type="text/javascript">


    function IsNumeric(dato) {
        var valor = dato.indexOf(".");
        if ((window.event.keyCode > 47 && window.event.keyCode < 58)) {
            window.event.returnValue = true;
        }
        else {
            window.event.returnValue = false;
        }
    }

    function consulta_dni() {

        var person_num_doc = $("#persona_num_documento").val().toString().trim();
        $.ajax({
            cache: false,
            type: "POST",
            url: "/HojaTramite/ConsultaDNI",
            data: { "person_num_doc": person_num_doc },
            success: function (data) {
                console.log(data);
            
                if (data[0].msg != null) {
                   // window.alert(data[0].msg);
                    document.getElementById('lbl_valida_persona_num_documento').innerHTML = data[0].msg;
                }
                else {
                    $('#paterno').val(data[0].apPrimer);
                    $('#materno').val(data[0].apSegundo);
                    $('#direccion').val(data[0].direccion);
                    $('#nombres').val(data[0].prenombres);
                    var arrayUbigeo = data[0].ubigeo.split('/');
                    console.log(arrayUbigeo);
                    $("#cmblista_departamento option:selected").text(arrayUbigeo[0]);
                    $("#cmblista_provincia option:selected").text(arrayUbigeo[1]);
                    $("#cmblista_distrito option:selected").text(arrayUbigeo[2]);
                }

                //Cierra Alerta
                $("#loadMe").modal("hide");
            },
            error: function (xhr, ajaxOptions, thrownError) {
                //Cierra Alerta
                $("#loadMe").modal("hide");
                alert('Failed to retrieve states.');
            }
        });

    }

    function consulta_data() {

        var person_num_doc = $("#persona_num_documento").val().toString().trim();

        document.getElementById('lbl_valida_persona_num_documento').innerHTML = "";

        $.ajax({
            cache: false,
            type: "GET",
            url: "@(Url.RouteUrl("Existe_persona"))",
            data: { "var_persona_num_doc": person_num_doc },
            success: function (result) {
                if (result == "SI") {
                    document.getElementById('lbl_valida_persona_num_documento').innerHTML = "Persona Existe";

                    $("#loadMe").modal("hide");
                }
                else
                {
                    consulta_dni()
                   
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                //Cierra Alerta
                $("#loadMe").modal("hide");
                alert('Failed to retrieve states.');
            }
        });
    }

    $(document).ready(function () {

        $(document).on("click", ".regresar", function () {
            window.location = '@Url.Action("Listar_Persona_Natural", "HojaTramite")';
        });

        var f = new Date();
        var fechaActual = (f.getDate() < 10 ? "0" + f.getDate() : f.getDate()) + "/" + ((f.getMonth() + 1) < 10 ? "0" + (f.getMonth() + 1) : (f.getMonth() + 1)) + "/" + f.getFullYear();

        $("#txtFechaNacimiento").val(fechaActual);

        $(function () {
            $('#dtpFechaNacimiento').datetimepicker({
                pickTime: false,
                format: 'dd/MM/yyyy',
                language: 'es'
            });
        });


        $("#cmblista_departamento").change(function () {
            var selectdepartamento = $(this).val();
            var ddlprovincia = $("#cmblista_provincia");
            $.ajax({
                cache: false,
                type: "GET",
                url: "@(Url.RouteUrl("llenar_provincia_x_departamento"))",
                data: { "id_departamento": selectdepartamento },
                success: function (data) {
                    ddlprovincia.html('');
                    $.each(data, function (id, option) {
                        ddlprovincia.append($('<option></option>').val(option.Value).html(option.Text));
                    });
                    $("#cmblista_provincia").change();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve states.');
                }
            });
        });


        $("#persona_num_documento").focusout(function () {

            if ($("#persona_num_documento").val().toString().trim().length >= 8 && $('#cmbtipo_doc_iden').val() == 1) {
                //Abre Popup
                $("#loadMe").modal({
                    backdrop: "static", //remove ability to close modal with click
                    keyboard: false, //remove option to close with keyboard
                    show: true //Display loader!
                });
                $('#cmbtipo_doc_iden').attr("disabled", true);
                //Trae Información
                consulta_data();
               
            }
        });

        //$("#persona_num_documento").keyup(function () {

        //    if ($("#persona_num_documento").val().toString().trim().length >= 8 && $('#cmbtipo_doc_iden').val() == 1) {
        //        //Abre Popup
        //        $("#loadMe").modal({
        //            backdrop: "static", //remove ability to close modal with click
        //            keyboard: false, //remove option to close with keyboard
        //            show: true //Display loader!
        //        });

        //        //Trae Información
        //        consulta_data();
        //    }
        //});

        $("#persona_num_documento").keypress(function () {

            if ($("#persona_num_documento").val().toString().trim().length >= 8 && $('#cmbtipo_doc_iden').val() == 1) {
                //Abre Popup
                $("#loadMe").modal({
                    backdrop: "static", //remove ability to close modal with click
                    keyboard: false, //remove option to close with keyboard
                    show: true //Display loader!
                });
                $('#cmbtipo_doc_iden').attr("disabled", true);
                //Trae Información
                consulta_data();
               
            }
        });



        $("#cmblista_provincia").change(function () {
            var selectprovincia = $("#cmblista_departamento").val() + $(this).val();
            var ddldistrito = $("#cmblista_distrito");
            $.ajax({
                cache: false,
                type: "GET",
                url: "@(Url.RouteUrl("llenar_distrito_x_provincia"))",
                data: { "id_provincia": selectprovincia },
                success: function (data) {
                    ddldistrito.html('');
                    $.each(data, function (id, option) {
                        ddldistrito.append($('<option></option>').val(option.Value).html(option.Text));
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve states.');
                }
            });
        });

       /* $('#persona_num_documento').on("click", function () {

            if ($("#persona_num_documento").val().toString().trim().length < 8) {

                document.getElementById('lbl_valida_persona_num_documento').innerHTML = "Documento Inválido";
            }
            else {
                consulta_dni();
            }

        }); */

        $('#btnLimpiar').click(function () {

            $("#persona_num_documento").val('');
            $("#paterno").val('');
            $("#materno").val('');
            $("#nombres").val('');
            $("#direccion").val('');
            $("#cmblista_sexo").val(0);
            $("#cmblista_departamento option:selected").text('SELECCIONAR DEPARTAMENTO');
            $("#cmblista_provincia option:selected").text('SELECCIONAR PROVINCIA');
            $("#cmblista_distrito option:selected").text('SELECCIONAR DISTRITO');
            $('#cmbtipo_doc_iden').attr("disabled", false);

        });


        $('#btnGrabar').click(function () {

            $("#persona_num_documento").val($("#persona_num_documento").val().trim().toUpperCase());
            $("#paterno").val($("#paterno").val().toUpperCase());
            $("#materno").val($("#materno").val().toUpperCase());
            $("#nombres").val($("#nombres").val().toUpperCase());
            $("#direccion").val($("#direccion").val().toUpperCase());

            document.getElementById('lbl_valida_persona_num_documento').innerHTML = "";
            document.getElementById('lbl_valida_paterno').innerHTML = "";
            document.getElementById('lbl_valida_materno').innerHTML = "";
            document.getElementById('lbl_valida_nombres').innerHTML = "";
            document.getElementById('lbl_valida_sexo').innerHTML = "";
            document.getElementById('lbl_valida_distrito').innerHTML = "";
            document.getElementById('lbl_valida_direccion').innerHTML = "";
            document.getElementById('lbl_valida_ruc').innerHTML = "";
            document.getElementById('lbl_valida_fecha_nacimiento').innerHTML = "";

            $("#fecha_nacimiento").val($("#txtFechaNacimiento").val());
            $("#sexo").val($("#cmblista_sexo").val());
            $("#tipo_doc_iden").val($("#cmbtipo_doc_iden").val());
            $("#ubigeo").val($("#cmblista_distrito").val());

            $('#btnGrabar').attr("disabled", "disabled");

            var entra = 0;

            if ($("#persona_num_documento").val().toString().trim().length < 8) {
                document.getElementById('lbl_valida_persona_num_documento').innerHTML = "Documento Inválido";
                entra = 1;
            } else {
                consulta_data();
            }

            if ($("#paterno").val().toString().trim() == "") {
                document.getElementById('lbl_valida_paterno').innerHTML = "Ingresar Apellido Paterno";
                entra = 1;
            }

            if ($("#materno").val().toString().trim() == "") {
                document.getElementById('lbl_valida_materno').innerHTML = "Ingresar Apellido Materno";
                entra = 1;
            }

            if ($("#nombres").val().toString().trim() == "") {
                document.getElementById('lbl_valida_nombres').innerHTML = "Ingresar Nombres";
                entra = 1;
            }

            /*
            var f2 = new Date();

            var dia = $("#txtFechaNacimiento").val().toString().split('/')[0];
            var mes = $("#txtFechaNacimiento").val().toString().split('/')[1];
            var año = parseInt($("#txtFechaNacimiento").val().toString().split('/')[2]) + 18;

            if (año > f2.getFullYear()) {
                document.getElementById('lbl_valida_fecha_nacimiento').innerHTML = "Debe ser mayor de edad";
                entra = 1;
            }
            else {
                if (año == f2.getFullYear()) {
                    if (mes > (f2.getMonth() + 1)) {
                        alert(f2.getMonth());
                        document.getElementById('lbl_valida_fecha_nacimiento').innerHTML = "Debe ser mayor de edad";
                        entra = 1;
                    }
                    else {
                        if ((mes == (f2.getMonth() + 1)) && (dia > f2.getDate())) {
                            alert(f2.getDate());
                            document.getElementById('lbl_valida_fecha_nacimiento').innerHTML = "Debe ser mayor de edad";
                            entra = 1;
                        }
                    }
                }
            }*/
            var var_ubigeo = "";
            if ($("#ubigeo").val().toString().trim() == "") {
                /*
                document.getElementById('lbl_valida_distrito').innerHTML = "Seleccionar Distrito";
                entra = 1;*/
                var_ubigeo = "140101";
            }
            else {
                var_ubigeo = $("#ubigeo").val().toString().trim();
            }


            if ($("#sexo").val().toString().trim() == "") {
                document.getElementById('lbl_valida_sexo').innerHTML = "Seleccionar Sexo";
                entra = 1;
            }

            if ($("#direccion").val().toString().trim() == "") {
                document.getElementById('lbl_valida_direccion').innerHTML = "Ingresar Dirección";
                entra = 1;
            }
            /*
            if ($("#ruc").val().toString().trim() != "" && $("#ruc").val().toString().trim().length < 11) {
                document.getElementById('lbl_valida_ruc').innerHTML = "Ingresar RUC";
                entra = 1;
            }*/

            if (entra == 1) {
                $('#btnGrabar').removeAttr("disabled", "disabled");
                return;
            }

            if ($("#var_guardar").val() == "1") {
                $('#btnGrabar').removeAttr("disabled", "disabled");
                return;
            }
            else {
                var var_persona_num_doc = $("#persona_num_documento").val().toString().trim();

                $.ajax({
                    cache: false,
                    type: "GET",
                    url: "@(Url.RouteUrl("Existe_persona"))",
                    data: { "var_persona_num_doc": var_persona_num_doc },
                    success: function (result) {
                        if (result == "SI") {
                            document.getElementById('lbl_valida_persona_num_documento').innerHTML = "Persona existe";
                            $('#btnGrabar').removeAttr("disabled", "disabled");
                            return;
                        }
                        else {
                            $("#var_guardar").val("1");
                            $.ajax({
                                cache: false,
                                type: "GET",
                                url: "/HojaTramite/Grabar_Nueva_Natural",
                                data: {
                                    "persona_num_documento": $("#persona_num_documento").val(),
                                    "tipo_doc_iden": $("#tipo_doc_iden").val(),
                                    "paterno": $("#paterno").val(),
                                    "materno": $("#materno").val(),
                                    "nombres": $("#nombres").val(),
                                    "fecha_nacimiento": $("#fecha_nacimiento").val(),
                                    "ubigeo": var_ubigeo,
                                    "sexo": $("#sexo").val(),
                                    "direccion": $("#direccion").val(),
                                    "ruc": $("#ruc").val()
                                },
                                beforeSend: function () {
                                    $('#progress').removeClass("hidden").addClass("show");
                                    $('#btnGrabar').attr("disabled", "disabled");
                                },
                                complete: function () {
                                    $('#progress').removeClass("show").addClass("hidden");
                                    $('#btnGrabar').attr("disabled", "disabled");
                                },
                                success: function (result) {
                                    $('.field-validation-error').each(function () {
                                        $(this).removeClass("field-validation-error").addClass("field-validation-valid");
                                        $(this).html('');
                                    });

                                    $("#mensajes").html(result).hide();
                                    $("html, body").animate({ scrollTop: 0 }, '500', 'swing', function () {
                                        $("#mensajes").slideDown(500, function () { });
                                        setTimeout(function () {
                                            window.location = '@Url.Action("Listar_Persona_Natural", "Hojatramite")';
                                        }, 500);
                                    });
                                },
                                error: function (result) {
                                    if (result.status == 500) {
                                        $("#mensajes").html(result.responseText).hide();
                                        $("#mensajes").slideDown(500, function () { });
                                    }
                                    else if (result.status == 400) {
                                        $('.field-validation-error').each(function () {
                                            $(this).removeClass("field-validation-error").addClass("field-validation-valid");
                                            $(this).html('');
                                        });
                                        $.each(result.responseJSON.errors, function (key, value) {
                                            if (value != null) {
                                                var container = $('span[data-valmsg-for="' + key + '"]');
                                                container.removeClass("field-validation-valid").addClass("field-validation-error");
                                                container.html(value);
                                            }
                                        });
                                        $("#mensajes").html(result.responseJSON.summary).hide();
                                        if (result.responseJSON.summary != "") {
                                            $("#mensajes").slideDown(500, function () { });
                                        }
                                    }
                                }
                            });
                        }


                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert('Failed to retrieve states.');
                    }
                });
            }

        });

    });
</script>
